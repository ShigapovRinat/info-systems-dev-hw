#!/bin/bash

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ —Å—Ç–µ–∫–æ–≤
print_stacks() {
    local max_height=8
    for ((i = max_height - 1; i >= 0; i--)); do
        printf "|%s|  |%s|  |%s|\n" \
            "${stack_A[i]:- }" \
            "${stack_B[i]:- }" \
            "${stack_C[i]:- }"
    done
    echo "+-+  +-+  +-+"
    echo " A    B    C"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–±–µ–¥—ã
check_victory() {
    local target=(8 7 6 5 4 3 2 1)
    if [[ "${stack_B[*]}" == "${target[*]}" || "${stack_C[*]}" == "${target[*]}" ]]; then
        echo "üéâ –ü–æ–±–µ–¥–∞! –í—Å–µ –¥–∏—Å–∫–∏ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã. üéâ"
        exit 0
    fi
}

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–µ–∫–æ–≤
stack_A=(8 7 6 5 4 3 2 1)
stack_B=()
stack_C=()

# –ù–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ —Ö–æ–¥–∞
move_count=0

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–∞ SIGINT
trap 'echo "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–≥—Ä—É –º–æ–∂–Ω–æ, –≤–≤–µ–¥—è q –∏–ª–∏ Q";' SIGINT

# –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –∏–≥—Ä—ã
while true; do
    # –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ö–æ–¥–∞
    move_count=$((move_count + 1))

    # –í—ã–≤–æ–¥ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å—Ç–µ–∫–æ–≤
    echo "–•–æ–¥ ‚Ññ $move_count:"
    print_stacks

    # –ó–∞–ø—Ä–æ—Å –¥–µ–π—Å—Ç–≤–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    read -p "–í–≤–µ–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, A B –∏–ª–∏ q/Q –¥–ª—è –≤—ã—Ö–æ–¥–∞): " input

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤—ã—Ö–æ–¥
    if [[ "$input" == "q" || "$input" == "Q" ]]; then
        echo "–í—ã—Ö–æ–¥ –∏–∑ –∏–≥—Ä—ã. –î–æ –≤—Å—Ç—Ä–µ—á–∏!"
        exit 0
    fi

    # –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    from=${input:0:1}
    to=${input: -1}

    # –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –±—É–∫–≤ –≤ –∑–∞–≥–ª–∞–≤–Ω—ã–µ
    from=$(echo "$from" | tr '[:lower:]' '[:upper:]')
    to=$(echo "$to" | tr '[:lower:]' '[:upper:]')

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –≤–≤–æ–¥–∞
    if [[ -z "$from" || -z "$to" || "$from" == "$to" || ! "$from" =~ [ABC] || ! "$to" =~ [ABC] ]]; then
        echo "‚ùå –û—à–∏–±–∫–∞: –≤–≤–µ–¥–∏—Ç–µ –¥–≤–∞ —Ä–∞–∑–Ω—ã—Ö —Å—Ç–µ–∫–∞ (A, B, C) –∏–ª–∏ q/Q –¥–ª—è –≤—ã—Ö–æ–¥–∞."
        continue
    fi

    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞-–∏—Å—Ç–æ—á–Ω–∏–∫–∞
    case "$from" in
        A) from_stack="stack_A" ;;
        üòé from_stack="stack_B" ;;
        C) from_stack="stack_C" ;;
    esac

    # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∞—Å—Å–∏–≤–∞-–ø–æ–ª—É—á–∞—Ç–µ–ª—è
    case "$to" in
        A) to_stack="stack_A" ;;
        üòé to_stack="stack_B" ;;
        C) to_stack="stack_C" ;;
    esac

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å—Ç–µ–∫-–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –Ω–µ –ø—É—Å—Ç
    eval "from_size=\${#$from_stack[@]}"
    if [[ "$from_size" -eq 0 ]]; then
        echo "‚ùå –û—à–∏–±–∫–∞: —Å—Ç–µ–∫ $from –ø—É—Å—Ç. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π."
        continue
    fi

    # –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–µ—Ä—Ö–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å—Ç–µ–∫–∞-–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±)
    eval "top_from=\${$from_stack[@]: -1}"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ `top_from` –ø–æ–ª—É—á–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
    if [[ -z "$top_from" ]]; then
        echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏–∑–≤–ª–µ—á—å –¥–∏—Å–∫ –∏–∑ —Å—Ç–µ–∫–∞ $from."
        continue
    fi

    # –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–µ—Ä—Ö–Ω–µ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å—Ç–µ–∫–∞-–ø–æ–ª—É—á–∞—Ç–µ–ª—è (–∏–ª–∏ 0, –µ—Å–ª–∏ –ø—É—Å—Ç)
    eval "to_size=\${#$to_stack[@]}"
    if [[ "$to_size" -eq 0 ]]; then
        top_to=0
    else
        eval "top_to=\${$to_stack[@]: -1}"
    fi

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤–∏–ª–∞: –Ω–µ–ª—å–∑—è –ø–æ–ª–æ–∂–∏—Ç—å –±–æ–ª—å—à–µ–µ —á–∏—Å–ª–æ –Ω–∞ –º–µ–Ω—å—à–µ–µ
    if [[ "$top_from" -gt "$top_to" && "$top_to" -ne 0 ]]; then
        echo "üö´ –¢–∞–∫–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ! –ù–µ–ª—å–∑—è –∫–ª–∞—Å—Ç—å –±–æ–ª—å—à–æ–π –¥–∏—Å–∫ –Ω–∞ –º–∞–ª–µ–Ω—å–∫–∏–π."
        continue
    fi

    # –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–∑ —Å—Ç–µ–∫–∞-–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
    eval "$from_stack=(\"\${$from_stack[@]:0:$(($from_size - 1))}\")"

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ —Å—Ç–µ–∫-–ø–æ–ª—É—á–∞—Ç–µ–ª—å
    eval "$to_stack+=(\"$top_from\")"

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–±–µ–¥—ã
    check_victory
done
